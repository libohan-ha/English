{% extends "base.html" %}

{% block content %}
<div class="story-container">
    <div class="story-controls">
        <button id="playButton" class="control-button">
            <span class="play-icon">â–¶</span> æœ—è¯»æ–‡ç« 
        </button>
        <button id="pauseButton" class="control-button" style="display: none;">
            <span class="pause-icon">â¸</span> æš‚åœæœ—è¯»
        </button>
        <button id="stopButton" class="control-button" style="display: none;">
            <span class="stop-icon">â¹</span> åœæ­¢æœ—è¯»
        </button>
    </div>

    <div class="story-content">
        {{ story.content|safe }}
    </div>
    
    <div class="word-list">
        <h3>å•è¯è§£é‡Šï¼š</h3>
        <ul class="word-definitions">
        {% for word in story.words %}
            <li class="word-item">
                <div class="word-header">
                    <span class="word">{{ word.word }}</span>
                    <span class="phonetic" id="phonetic-{{ word.word }}"></span>
                    <button class="word-speaker" onclick="speakWord('{{ word.word }}')">
                        <span class="speaker-icon">ğŸ”Š</span>
                    </button>
                </div>
                <div class="word-meaning">{{ word.definition }}</div>
            </li>
        {% endfor %}
        </ul>
    </div>
    
    <div class="story-navigation">
        {% if prev_story %}
        <a href="{{ url_for('story', story_id=prev_story.id) }}" class="nav-link prev-link">
            <span class="nav-arrow">â†</span> ä¸Šä¸€ç¯‡
        </a>
        {% endif %}
        
        <a href="/" class="back-link">è¿”å›é¦–é¡µ</a>
        
        {% if next_story %}
        <a href="{{ url_for('story', story_id=next_story.id) }}" class="nav-link next-link">
            ä¸‹ä¸€ç¯‡ <span class="nav-arrow">â†’</span>
        </a>
        {% endif %}
    </div>
</div>

<script>
let speechUtterance = null;
const synth = window.speechSynthesis;

// æ–‡ç« æœ—è¯»åŠŸèƒ½
function setupSpeech() {
    const playButton = document.getElementById('playButton');
    const pauseButton = document.getElementById('pauseButton');
    const stopButton = document.getElementById('stopButton');
    const content = document.querySelector('.story-content').textContent;

    playButton.addEventListener('click', () => {
        if (speechUtterance === null) {
            speechUtterance = new SpeechSynthesisUtterance(content);
            speechUtterance.lang = 'en-US';
            speechUtterance.rate = 0.9;
            speechUtterance.pitch = 1;
            
            speechUtterance.onend = () => {
                playButton.style.display = 'inline-block';
                pauseButton.style.display = 'none';
                stopButton.style.display = 'none';
                speechUtterance = null;
            };
        }
        
        synth.speak(speechUtterance);
        playButton.style.display = 'none';
        pauseButton.style.display = 'inline-block';
        stopButton.style.display = 'inline-block';
    });

    pauseButton.addEventListener('click', () => {
        if (synth.speaking) {
            if (synth.paused) {
                synth.resume();
                pauseButton.innerHTML = '<span class="pause-icon">â¸</span> æš‚åœæœ—è¯»';
            } else {
                synth.pause();
                pauseButton.innerHTML = '<span class="play-icon">â–¶</span> ç»§ç»­æœ—è¯»';
            }
        }
    });

    stopButton.addEventListener('click', () => {
        synth.cancel();
        playButton.style.display = 'inline-block';
        pauseButton.style.display = 'none';
        stopButton.style.display = 'none';
        speechUtterance = null;
    });
}

// å•è¯æœ—è¯»åŠŸèƒ½
function speakWord(word) {
    synth.cancel(); // åœæ­¢å½“å‰æœ—è¯»
    const utterance = new SpeechSynthesisUtterance(word);
    utterance.lang = 'en-US';
    utterance.rate = 0.8;
    synth.speak(utterance);
}

// è·å–å•è¯éŸ³æ ‡
async function fetchPhonetic(word) {
    try {
        const response = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`);
        const data = await response.json();
        if (data && data[0] && data[0].phonetic) {
            const phoneticSpan = document.getElementById(`phonetic-${word}`);
            phoneticSpan.textContent = data[0].phonetic;
        }
    } catch (error) {
        console.error('Error fetching phonetic:', error);
    }
}

// ä¸ºæ‰€æœ‰å•è¯è·å–éŸ³æ ‡
document.addEventListener('DOMContentLoaded', () => {
    setupSpeech();
    const words = document.querySelectorAll('.word');
    words.forEach(wordElement => {
        const word = wordElement.textContent.trim();
        fetchPhonetic(word);
    });
});
</script>
{% endblock %} 